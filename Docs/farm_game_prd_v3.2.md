# 农场小游戏需求分析书 (v3.2)

## 1. 引言

### 1.1 项目概述

本项目旨在开发一个基于[Miao-Yunzai框架](https://github.com/yoimiya-kokomi/Miao-Yunzai/tree/master)框架、[ICQQ适配器](https://icqq.pages.dev/)的文字/指令式农场小游戏插件。玩家通过简单的指令，可以在自己的虚拟农场中进行种植、收获、买卖道具等操作，并与其他玩家进行互动（如偷菜）。游戏的核心乐趣在于农场经营的成就感、道具使用的策略性以及玩家之间的互动竞争。

### 1.2 项目目标

- **功能目标：** 构建一套完整的农场种植、收获、物品管理和交易系统。
- **交互目标：** 实现玩家间的互动机制，特别是偷窃功能和相应的防御机制。
- **体验目标：** 提供简洁易懂的指令操作方式，降低用户上手门槛。
- **技术目标：** 确保游戏数值的可配置性，方便后续调整平衡。
- **运营目标：** 提高群聊活跃度，增加用户粘性和互动频率。
- **长期目标：** 构建深度的成长体系，为玩家提供长期的追求目标。

### 1.3 范围与非目标

**项目范围 (In-Scope):**

- 玩家基础信息（等级、经验、金币）的存储与管理
- **双维度土地系统**：土地扩张（增加数量）+ 土地品质进阶（提升效率）
- **土地品质体系**：普通、铜质、银质、金质四个品质等级
- 作物生命周期管理（种子、生长阶段、成熟、可偷、可收获）
- 物品系统（种子、肥料、狗粮、道具等）的购买、出售、使用与存储
- 完整的农场操作指令集（种植、浇水、施肥、除虫、收获）
- 玩家间偷窃系统及防御机制
- 物品锁定功能
- 签到奖励系统
- 管理员功能
- 游戏数值的可配置化
- 离线状态期间的游戏状态暂停
- **经济平衡模型**：确保升级成本与收益的合理平衡

**项目非目标 (Out-of-Scope):**

- 复杂的玩家社交系统（好友、公会等）
- 除偷窃外的其他玩家交互模式（赠送、合作等）
- 高级农场功能（天气系统、病虫害等）
- 狗的养成、升级或复杂行为系统
- 自动化农场工具（自动浇水机等）
- 实时聊天或语音功能

## 2. 核心功能需求

### 2.1 玩家注册与信息管理

#### 2.1.1 玩家注册

- **触发方式：** 玩家首次使用任意游戏指令时自动注册。
- **初始资源：** 根据配置文件设定初始金币、经验、等级、土地数量、仓库容量。
- **初始礼包：** 注册后自动获得**初始礼包**，内容在 `config/items.yaml` 中的 `initial_gift` 字段配置，包含新手种子和基础道具。
  ```yaml
  initial_gift:
    - item_id: 'wheat_seed'
      quantity: 10
    - item_id: 'fertilizer_normal'
      quantity: 5
  ```

#### 2.1.2 玩家信息查询

- **指令：** `#nc我的信息` 或 `#nc信息`
- **显示内容：**
  - 昵称/ID、当前等级、经验值（当前/升级所需）
  - 金币数量、土地数量（当前/最大）
  - 仓库容量（当前使用/最大容量）
  - 当前狗粮保护状态
  - 偷菜冷却状态

#### 2.1.3 玩家数据重置（管理员功能）

- **指令：** `#nc管理 重置玩家 @用户`
- **权限：** 仅限机器人主人使用。

### 2.2 等级系统

#### 2.2.1 经验获取

- **主要来源：** 收获成熟作物（经验值与作物价值成正比）。
- **品质加成：** 在高品质土地收获作物可获得经验加成。
- **签到奖励：** 每日签到可获得少量经验值。
- **计算公式：** 经验值 = 作物基础价值 × 经验系数 × 土地品质加成（可配置）。

#### 2.2.2 等级提升

- **升级条件：** 经验值达到预设阈值。
- **等级加成：** 每级提升增加土地数量上限，解锁高品质土地进阶权限。
- **等级上限：** 100级（为未来扩展预留空间）。
- **升级奖励：** 可配置的金币奖励和消耗品组合包（如：种子、肥料等）。

### 2.3 经济系统

#### 2.3.1 金币获取

- **出售作物：** 主要金币来源。
- **签到奖励：** 每日随机金币。
- **品质加成：** 高品质土地产出的作物价值更高。

#### 2.3.2 商店系统

- **查看商店：** `#nc商店`（显示可购买的物品列表）。
- **查看市场：** `#nc市场`（显示当前售价信息）。
- **商品分类：** 种子、肥料、狗粮、道具、土地进阶材料。
- **购买指令：** `#nc购买 <物品名字> <数量>`
- **价格机制：** 固定价格（初期版本），购买价格在商店显示，售价在市场显示。

#### 2.3.3 出售系统

- **出售指令：** `#nc出售 <物品名字> <数量>`
- **批量出售：** `#nc出售全部` （仅出售作物）。
- **价格机制：** 固定价格（可配置，未来可扩展为动态价格）。
- **限制条件：** 被锁定的物品不可出售。

#### 2.3.4 经济平衡模型

- **收入-支出平衡：** 确保玩家的金币收入能够支撑合理的升级节奏。
- **通胀控制：** 土地升级作为主要的金币回收机制，防止经济失衡。
- **投资回报：** 土地升级的成本应在合理时间内通过产量提升收回。

### 2.4 土地系统（重新设计）

#### 2.4.1 土地管理基础

- **初始土地：** 6块普通品质土地（可配置）。
- **土地编号：** 从1开始递增编号。
- **最大土地：** 24块。
- **土地状态：** 空闲、种植中、成熟。

#### 2.4.2 土地扩张系统（横向发展）

- **扩张指令：** `#nc土地扩张`
- **扩张机制：** 玩家达到指定等级后，可消耗金币开垦新的土地。
- **扩张数量：** 每次扩张1块土地。
- **等级要求：** 参考以下配置：

| 土地编号 | 等级要求 | 扩张成本(金币) | 备注 |
|---------|---------|---------------|------|
| 1-6     | 初始    | 0             | 注册时免费获得 |
| 7       | Lv.5    | 1,000         | 第7块土地 |
| 8       | Lv.7    | 2,000         | 第8块土地 |
| 9       | Lv.9    | 3,000         | 第9块土地 |
| ...     | ...     | ...           | 按配置递增 |
| 24      | Lv.39   | 20,000        | 最后一块土地 |

#### 2.4.3 土地品质进阶系统（纵向发展）

**核心概念：** 每块土地都有品质等级，高品质土地提供显著的生产加成。

**四种品质等级：**
- **普通土地（默认）：** 无加成
- **铜质土地：** 增产+10%，时间-10%
- **银质土地：** 增产+20%，时间-20%
- **金质土地：** 增产+28%，时间-20%，经验+28%

**进阶条件：**
- **等级要求：** 玩家达到特定等级才能进阶对应品质
- **金币消耗：** 消耗大量金币进行品质进阶
- **材料需求：** 消耗特殊材料（通过任务、签到、活动获得）

**进阶指令：** `#nc土地进阶 <地号>`

**进阶配置示例：**
```yaml
land_quality_upgrade:
  copper:
    level_required: 28
    gold_cost: 50,000
    materials:
      - item_id: 'copper_essence'
        quantity: 1
  silver:
    level_required: 40
    gold_cost: 200,000
    materials:
      - item_id: 'silver_essence'
        quantity: 1
  gold:
    level_required: 58
    gold_cost: 800,000
    materials:
      - item_id: 'gold_essence'
        quantity: 1
```

#### 2.4.4 土地强化系统（微调优化）

**强化指令：** `#nc强化土地 <地号>`
**强化效果：** 在品质加成基础上，进一步微幅提升土地效率。
**强化上限：** 每块土地最多强化5次。
**强化成本：** 消耗金币，成本随强化次数递增。

**与品质系统的关系：**
- 强化是在品质基础上的增量提升
- 不同品质的土地强化成本不同（高品质土地强化更昂贵）
- 强化效果叠加在品质效果之上

### 2.5 种植系统

#### 2.5.1 种植操作

- **种植指令：** `#nc种植 <种子名称> <地号>`
- **批量种植：** `#nc种植全部 <种子名称>`
- **种植条件：** 土地为空闲状态，拥有对应种子。
- **种植反馈：** 成功/失败提示，剩余种子数量，预计收获时间（考虑土地品质加成）。

#### 2.5.2 作物护理

- **浇水指令：** `#nc浇水 <地号>` / `#nc浇水全部`
- **施肥指令：** `#nc施肥 <地号>` / `#nc施肥全部`
- **除虫指令：** `#nc除虫 <地号>` / `#nc除虫全部`
- **护理效果：**
  - 浇水：去除缺水状态，停止健康度继续下降。
  - 施肥：加速生长，需消耗肥料。
  - 除虫：去除害虫状态，停止健康度继续下降。
- **批量操作逻辑：** 遍历玩家所有土地，对存在相应负面状态或可施肥的土地执行操作。

#### 2.5.3 作物状态

- **健康度：** 0-100%，影响最终产量。
- **生长阶段：** 种植中 → 生长期 → 成熟期。
- **品质影响：** 高品质土地缩短生长时间，提高基础产量。
- **可偷属性：** 当作物进入成熟期时，自动获得"可偷窃"属性。
- **负面状态：** 缺水、害虫（降低健康度）。
- **状态显示格式：** `[品质][地号]：[作物名] [健康度] [成熟时间] [负面状态] [可偷窃]`

### 2.6 收获系统

#### 2.6.1 收获操作

- **收获指令：** `#nc收获`（自动收获所有成熟作物）。
- **收获条件：** 作物处于成熟状态。
- **仓库检查：** 自动检查仓库容量，若已满，则按土地编号从小到大的顺序收获作物。
- **溢出处理：** 仓库已满未能收获的成熟作物，将继续保留在土地上。

#### 2.6.2 收获奖励计算

- **基础产量：** 根据作物类型和健康度计算。
- **品质加成：** 应用土地品质的增产百分比。
- **强化加成：** 应用土地强化的额外加成。
- **经验计算：** 基础经验 × 土地品质经验加成。
- **收获反馈：** 显示获得的作物数量和经验值，明确展示加成效果。

### 2.7 仓库系统

#### 2.7.1 仓库管理

- **查看仓库：** `#nc仓库` 
- **初始容量：** 20格（可配置）。
- **物品堆叠：** 同类物品叠加存储，不同类型占用不同格子。

#### 2.7.2 仓库升级

- **升级指令：** `#nc仓库升级`
- **升级条件：** 消耗金币。
- **容量增加：** 每次升级增加10格（可配置）。
- **升级上限：** 最大200格（可配置）。

#### 2.7.3 物品锁定

- **锁定指令：** `#nc锁定 <物品名字>`
- **解锁指令：** `#nc解锁 <物品名字>`
- **锁定效果：** 防止误出售，不影响使用。
- **状态显示：** 锁定物品名称后显示[锁定]标记。

### 2.8 偷窃系统

#### 2.8.1 偷窃操作

- **偷窃指令：** `@玩家 #nc偷菜`
- **偷窃目标：** 目标玩家土地上所有处于"成熟且可偷"状态的作物。
- **偷窃范围：** 执行一次指令，将对目标所有符合条件的土地分别进行一次偷窃判定。

#### 2.8.2 成功率与数量计算

- **单块土地偷窃成功率：** `(偷窃者基础成功率 + 道具加成 - 狗粮防御)`
- **基础成功率：** 40%（可配置）。
- **成功率上限：** 不超过80%。
- **偷窃数量：** 若单块土地偷窃成功，可偷得的作物数量为随机值（可配置），但不能超过该作物"剩余可被偷数量"。

#### 2.8.3 偷窃限制

- **产量上限：** 每块土地的作物在每次成熟后，最多可被所有玩家累计偷取其总产量的40%（可配置）。
- **玩家限制：** 每个玩家对同一块土地的同一次成熟作物，只能进行一次偷窃尝试。
- **技术实现：** 在Redis中为每批成熟作物生成唯一的成熟周期ID。

#### 2.8.4 偷窃结果与冷却

- **成功反馈：** "偷窃成功！获得了X个[作物名]"
- **失败反馈：** "偷窃失败，被狗发现了！"
- **重复尝试：** "您已经对这块地下过手了，换个目标吧！"
- **失败惩罚：** 偷窃失败时，计算目标农场所有可偷作物总价值的20%作为罚款。
- **偷窃者冷却：** 执行偷窃后进入5分钟冷却。
- **被偷者保护：** 只有当成功偷到作物后，被偷者的整个农场进入30分钟保护期。

### 2.9 防御系统

#### 2.9.1 狗与狗粮

- **狗粮品质：** 普通、高级、优质
- **使用指令：** `#nc使用 <狗粮名称>`
- **防御机制：** 降低被偷成功率
- **持续时间：** 根据狗粮品质决定（30分钟-2小时）
- **效果叠加：** 新使用覆盖旧效果，不叠加

#### 2.9.2 防御效果

- **普通狗粮：** -20%成功率，持续30分钟。
- **高级狗粮：** -35%成功率，持续1小时。
- **优质狗粮：** -50%成功率，持续2小时。

### 2.10 签到系统

#### 2.10.1 每日签到

- **签到指令：** `#nc签到`
- **签到限制：** 每日只能签到一次。
- **签到奖励：** 随机金币、种子、经验值、土地进阶材料。

#### 2.10.2 连续签到

- **连签加成：** 连续签到天数越多，奖励越丰富。
- **连签中断：** 漏签一天则连签天数重置。
- **特殊奖励：** 连签7天、30天有特殊道具奖励，包括稀有的土地进阶材料。

### 2.11 权限与管理功能

#### 2.11.1 权限体系

系统内置两级权限：
- **玩家：** 默认所有用户，可使用所有基础游戏功能。
- **主人：** 通过 `e.isMaster` 判断主人，拥有所有管理权限。
- **扩展性：** 未来可支持群聊内的**管理员**权限。

#### 2.11.2 数据管理

- **重置玩家：** `#nc管理 重置玩家 @用户`
- **添加金币：** `#nc管理 添加金币 @用户 <数量>`
- **添加经验：** `#nc管理 添加经验 @用户 <数量>`
- **查看数据：** `#nc管理 查看数据 @用户`
- **土地品质调整：** `#nc管理 设置土地品质 @用户 <地号> <品质>`

#### 2.11.3 系统管理

- **重载配置：** `#nc管理 重载配置`
- **查看统计：** `#nc管理 统计`
- **数据备份：** `#nc管理 备份`
- **发布公告：** `#nc管理 公告 <内容>`
- **经济分析：** `#nc管理 经济分析`（查看整体经济状况）

## 3. 完整指令索引

### 3.1 基础指令

| 指令 | 功能 | 示例 |
| :--- | :--- | :--- |
| `#nc我的农场` | 查看自己的农场状态 | `#nc我的农场` |
| `@用户 #nc农场` | 查看他人农场 | `@张三 #nc农场` |
| `#nc我的信息` | 查看玩家信息 | `#nc我的信息` |
| `#nc仓库` | 查看仓库 | `#nc仓库` |
| `#nc签到` | 每日签到 | `#nc签到` |
| `#nc帮助` | 查看帮助信息 | `#nc帮助` |

### 3.2 农场操作

| 指令 | 功能 | 示例 |
| :--- | :--- | :--- |
| `#nc种植 <种子> <地号>` | 种植作物 | `#nc种植 小麦种子 1` |
| `#nc种植全部 <种子>` | 批量种植 | `#nc种植全部 小麦种子` |
| `#nc浇水 <地号>` | 给作物浇水 | `#nc浇水 1` |
| `#nc浇水全部` | 批量浇水 | `#nc浇水全部` |
| `#nc施肥 <地号>` | 给作物施肥 | `#nc施肥 1` |
| `#nc施肥全部` | 批量施肥 | `#nc施肥全部` |
| `#nc除虫 <地号>` | 给作物除虫 | `#nc除虫 1` |
| `#nc除虫全部` | 批量除虫 | `#nc除虫全部` |
| `#nc收获` | 收获所有成熟作物 | `#nc收获` |

### 3.3 商店交易

| 指令 | 功能 | 示例 |
| :--- | :--- | :--- |
| `#nc商店` | 查看商店（购买物品） | `#nc商店` |
| `#nc市场` | 查看市场（售价信息） | `#nc市场` |
| `#nc购买 <物品> <数量>` | 购买物品 | `#nc购买 小麦种子 10` |
| `#nc出售 <物品> <数量>` | 出售指定数量物品 | `#nc出售 小麦 5` |
| `#nc出售全部` | 出售所有作物 | `#nc出售全部` |

### 3.4 土地管理（更新）

| 指令 | 功能 | 示例 |
| :--- | :--- | :--- |
| `#nc土地扩张` | 扩张土地（增加数量） | `#nc土地扩张` |
| `#nc土地进阶 <地号>` | 土地品质进阶 | `#nc土地进阶 1` |
| `#nc强化土地 <地号>` | 强化单块土地 | `#nc强化土地 1` |
| `#nc土地详情 <地号>` | 查看土地详细信息 | `#nc土地详情 1` |
| `#nc仓库升级` | 升级仓库 | `#nc仓库升级` |

### 3.5 物品管理

| 指令 | 功能 | 示例 |
| :--- | :--- | :--- |
| `#nc使用 <物品>` | 使用物品 | `#nc使用 普通狗粮` |
| `#nc锁定 <物品>` | 锁定物品 | `#nc锁定 小麦` |
| `#nc解锁 <物品>` | 解锁物品 | `#nc解锁 小麦` |

### 3.6 交互功能

| 指令 | 功能 | 示例 |
| :--- | :--- | :--- |
| `@用户 #nc偷菜` | 偷取他人作物 | `@张三 #nc偷菜` |

### 3.7 管理员指令（更新）

| 指令 | 功能 | 权限要求 |
| :--- | :--- | :--- |
| `#nc管理 重置玩家 @用户` | 重置玩家数据 | 主人 |
| `#nc管理 添加金币 @用户 <数量>` | 添加金币 | 主人 |
| `#nc管理 设置土地品质 @用户 <地号> <品质>` | 调整土地品质 | 主人 |
| `#nc管理 重载配置` | 重载配置文件 | 主人 |
| `#nc管理 统计` | 查看游戏统计 | 主人 |
| `#nc管理 经济分析` | 查看经济状况 | 主人 |

### 3.8 帮助系统

- **帮助：** `#nc帮助` 显示所有指令分类列表

## 4. 非功能性需求

### 4.1 性能要求

- **响应时间：** 指令响应时间 < 3秒。
- **并发处理：** 支持同时处理100+用户操作。
- **数据处理：** Redis操作耗时 < 100ms。
- **内存使用：** 插件内存占用 < 50MB。

### 4.2 可靠性要求

- **数据安全：** 防止数据丢失，定期自动备份。
- **异常处理：** 完整的错误捕获和处理机制。
- **降级方案：** 若框架的Redis服务不可用，插件应能捕获异常并返回友好提示。
- **数据锁：** 所有涉及修改玩家数据的原子性操作，必须采用基于用户ID的分布式锁。

### 4.3 可配置性

- **游戏数值：** 所有数值参数可通过配置文件调整。
- **功能开关：** 各模块功能可独立启用/禁用。
- **环境适配：** 支持开发/生产环境不同配置。
- **热重载范围：** 主要针对游戏数值和定义文件。

### 4.4 系统兼容性

- **Miao-Yunzai版本：** 兼容最新稳定版本。
- **Node.js版本：** 支持Node.js 16+。
- **文件系统：** 支持yaml文件读写。
- **操作系统：** 支持Windows/Linux/MacOS。

### 4.5 用户反馈与验证规则

#### 4.5.1 错误提示信息

- **金币不足：** `"叮当~口袋空空！购买/升级失败，还差 X 金币。"`
- **等级不够：** `"经验值还不够哦，再升 X 级就可以解锁啦！"`
- **物品不足：** `"背包里没有找到 [物品名称]，无法使用/种植。"`
- **土地状态错误：** `"操作失败，请确保地号正确且土地处于空闲状态。"`
- **材料不足：** `"进阶失败，还需要 [材料名称] x X。"`
- **指令错误：** `"咦？好像没听懂您的指令，试试发送 #nc帮助 看看吧~"`
- **冷却中：** `"操作太频繁啦，请等待 X 分钟后再试。"`

#### 4.5.2 参数验证规则

- **地块编号：** 必须为玩家已拥有土地范围内的正整数。
- **物品数量：** 必须为正整数，且不能超过背包持有量。
- **品质类型：** 必须为预定义的品质类型（普通、铜质、银质、金质）。
- **非法输入：** 对所有用户输入进行基本的过滤，拒绝特殊字符和过长输入。
- **负数处理：** 所有用户输入的数量参数必须经过校验，拒绝负数和0。

## 5. 经济平衡设计

### 5.1 经济模型基础

#### 5.1.1 收入源分析

- **主要收入：** 作物出售（占总收入90%以上）
- **辅助收入：** 签到奖励、偷菜收益
- **收入影响因素：** 土地品质、土地数量、作物选择、在线时长

#### 5.1.2 支出分析

- **主要支出：** 土地扩张、土地进阶、种子购买
- **辅助支出：** 仓库升级、道具购买、土地强化
- **支出特点：** 前期以扩张为主，后期以品质提升为主

### 5.2 平衡策略

#### 5.2.1 成本递增模型

- **扩张成本：** 采用指数增长模型，确保后期土地获取有挑战性
- **进阶成本：** 高品质土地进阶需要大量金币投入
- **回报周期：** 确保升级投资在合理时间内（1-2周）能够回本

#### 5.2.2 品质投资回报

**收益计算公式：**
```
日均额外收益 = (土地品质加成% × 基础日产值) - (进阶成本 / 回本天数)
```

**目标平衡点：**
- 铜质土地：7-10天回本
- 银质土地：14-20天回本  
- 金质土地：30-45天回本

### 5.3 数值配置策略

#### 5.3.1 分阶段实施

**第一阶段（V1.0）：**
- 开放前15块土地扩张
- 实装普通、铜质两种品质
- 建立基础经济循环

**第二阶段（V1.1）：**
- 开放全部24块土地
- 解锁银质土地进阶
- 优化经济平衡

**第三阶段（V1.2）：**
- 开放金质土地进阶
- 完善长期目标体系
- 引入高级道具

#### 5.3.2 监控指标

- **玩家等级分布：** 确保各等级段玩家占比合理
- **金币流通速度：** 监控玩家金币积累和消耗情况
- **升级完成率：** 统计各品质土地的升级成功率
- **活跃度变化：** 观察升级系统对玩家留存的影响

## 6. 技术实现方案

### 6.1 存储策略

#### 6.1.1 Redis键命名策略（更新）

- **玩家数据 (Hash)：** `farm:player:<qq_id>` 
  - 字段：`gold`、`exp`、`level`、`lands_count`、`warehouse_capacity`
- **土地数据 (Hash)：** `farm:land:<qq_id>:<land_num>`
  - 字段：`crop_id`、`plant_time`、`harvest_time`、`health`、`status`、`quality`、`enhancement_level`
- **土地品质 (Hash)：** `farm:land_quality:<qq_id>`
  - 字段为土地编号，值为品质类型
- **玩家仓库 (Hash)：** `farm:inventory:<qq_id>`
- **冷却时间 (String)：** `farm:cd:steal:<qq_id>`
- **偷窃记录 (String)：** `farm:steal_attempt:<attacker_id>:<target_land_id>:<cycle_id>`

#### 6.1.2 配置文件结构（更新）

```
config/
├── default_config/
│   ├── config.yaml           # 主配置文件
│   ├── crops.yaml           # 作物配置
│   ├── items.yaml           # 物品配置
│   ├── levels.yaml          # 等级配置
│   ├── land_expansion.yaml  # 土地扩张配置
│   └── land_quality.yaml   # 土地品质配置（新增）
```

**land_quality.yaml 示例：**
```yaml
quality_types:
  normal:
    name: "普通"
    color: "#888888"
    production_bonus: 0
    time_reduction: 0
    exp_bonus: 0
  copper:
    name: "铜质"
    color: "#CD7F32"
    production_bonus: 10
    time_reduction: 10
    exp_bonus: 0
  silver:
    name: "银质"
    color: "#C0C0C0"
    production_bonus: 20
    time_reduction: 20
    exp_bonus: 0
  gold:
    name: "金质"
    color: "#FFD700"
    production_bonus: 28
    time_reduction: 20
    exp_bonus: 28

upgrade_requirements:
  copper:
    level_required: 28
    gold_cost: 50000
    materials:
      - item_id: 'copper_essence'
        quantity: 1
  silver:
    level_required: 40
    gold_cost: 200000
    materials:
      - item_id: 'silver_essence'
        quantity: 1
  gold:
    level_required: 58
    gold_cost: 800000
    materials:
      - item_id: 'gold_essence'
        quantity: 1
```

### 6.2 插件架构设计（更新）

```
plugins/farm_game/
├── index.js                  # 插件入口
├── package.json              # 包依赖配置
├── config/
│   └── default_config/       # 默认配置（已更新）
├── data/                     # 数据存储目录
├── apps/                     # 功能模块
│   ├── farm.js               # 农场操作
│   ├── shop.js               # 商店系统
│   ├── steal.js              # 偷菜系统
│   ├── inventory.js          # 仓库管理
│   ├── sign.js               # 签到系统
│   ├── land_management.js    # 土地管理（新增）
│   └── admin.js              # 管理功能
├── models/                   # 数据模型
│   ├── Player.js             # 玩家模型
│   ├── Farm.js               # 农场模型
│   ├── Land.js               # 土地模型（新增）
│   ├── Item.js               # 物品模型
│   └── Config.js             # 配置模型
├── utils/                    # 工具函数
│   ├── redis.js              # Redis操作封装
│   ├── fileStorage.js        # 文件存储操作
│   ├── calculator.js         # 游戏计算（更新）
│   ├── economyBalance.js     # 经济平衡计算（新增）
│   ├── validator.js          # 数据验证
│   └── formatter.js          # 格式化输出
└── resources/                # 资源文件
    ├── templates/            # 渲染模板
    └── images/               # 图片资源
```

### 6.3 关键算法设计

#### 6.3.1 品质加成计算

```javascript
// 计算作物产量（包含品质加成）
function calculateHarvestYield(baseCrop, landQuality, landEnhancement, health) {
    const baseYield = baseCrop.baseYield;
    const healthMultiplier = health / 100;
    const qualityBonus = landQuality.production_bonus / 100;
    const enhancementBonus = landEnhancement * 0.02; // 每次强化+2%
    
    return Math.floor(baseYield * healthMultiplier * (1 + qualityBonus + enhancementBonus));
}

// 计算生长时间（包含品质减时）
function calculateGrowthTime(baseCrop, landQuality) {
    const baseTime = baseCrop.growthTime;
    const timeReduction = landQuality.time_reduction / 100;
    
    return Math.floor(baseTime * (1 - timeReduction));
}

// 计算经验获得（包含品质加成）
function calculateExpGain(baseExp, landQuality) {
    const expBonus = landQuality.exp_bonus / 100;
    
    return Math.floor(baseExp * (1 + expBonus));
}
```

#### 6.3.2 经济平衡检查

```javascript
// 检查升级投资回报率
function validateUpgradeROI(currentQuality, targetQuality, playerLevel) {
    const upgradeCost = getUpgradeCost(currentQuality, targetQuality);
    const dailyBenefit = calculateDailyBenefit(targetQuality) - calculateDailyBenefit(currentQuality);
    const paybackPeriod = upgradeCost / dailyBenefit;
    
    // 确保回本周期在合理范围内
    const maxPaybackDays = getMaxPaybackDays(targetQuality);
    return paybackPeriod <= maxPaybackDays;
}
```

## 7. 图片渲染方案 (远期规划)

为了提供更丰富、更直观的用户体验，项目远期计划将核心信息的展示从纯文本升级为图片。

### 7.1 渲染内容规划

- **农场概览图：** 展示所有土地的状态、品质、作物信息
- **土地详情图：** 单块土地的详细信息，包括品质特效
- **仓库界面图：** 物品图标化展示
- **统计报告图：** 经济数据可视化

### 7.2 技术方案

- **技术选型：** 使用`Puppeteer`等无头浏览器库
- **品质展示：** 不同品质土地使用不同的颜色和特效
- **配置开关：** 可选启用/禁用图片渲染功能

## 8. 测试策略

### 8.1 单元测试

- 品质加成计算逻辑测试
- 经济平衡模型验证
- 土地升级流程测试
- 数据模型测试

### 8.2 集成测试

- 完整土地管理流程测试
- 多品质土地并发操作测试
- 经济系统长期稳定性测试
- 性能压力测试

### 8.3 平衡性测试

- 不同玩家等级的升级成本合理性
- 各品质土地的投资回报率
- 长期经济数据模拟
- 玩家行为模式分析

## 9. 部署与运维

### 9.1 部署要求

- **环境依赖：** Node.js 16+, 文件系统读写权限
- **权限要求：** 文件读写权限，数据目录访问权限
- **资源需求：** 内存256MB+，存储500MB+

### 9.2 监控指标（更新）

- 指令处理成功率
- 平均响应时间
- Redis读写状态
- 错误发生频率
- 用户活跃度统计
- **经济指标：** 金币流通量、升级完成率、品质分布
- **平衡指标：** 各等级玩家分布、升级成功率

## 10. 开发计划

### 10.1 开发阶段划分（更新）

#### 第一阶段（核心功能）- V1.0

- [ ] 基础框架搭建
- [ ] 玩家注册与信息管理
- [ ] 种植与收获系统
- [ ] 基础商店功能
- [ ] 简单的仓库管理
- [ ] **土地扩张系统（前15块）**
- [ ] **土地品质系统（普通、铜质）**

#### 第二阶段（交互功能）- V1.1

- [ ] 偷菜系统实现
- [ ] 防御机制（狗与狗粮）
- [ ] **银质土地解锁**
- [ ] **全部24块土地开放**
- [ ] 物品锁定功能

#### 第三阶段（完善功能）- V1.2

- [ ] 签到系统
- [ ] 管理员功能
- [ ] 统计与监控
- [ ] **金质土地解锁**
- [ ] **土地强化系统**
- [ ] **经济分析工具**
- [ ] 性能优化

#### 第四阶段（增强功能）- V2.0

- [ ] 图片渲染支持
- [ ] 高级道具系统
- [ ] 数据分析报告
- [ ] **特殊活动支持**

### 10.2 质量保证

- 每阶段完成后进行完整测试
- 特别重视经济平衡性测试
- 定期进行代码审查
- 持续集成和自动化测试
- 用户反馈收集和迭代优化

## 11. 风险评估与应对

### 11.1 技术风险

- **框架Redis服务不可用：** 通过异常处理机制，向用户返回友好提示
- **性能瓶颈：** 优化Redis命令，使用管道操作减少网络往返
- **数据丢失：** 依赖框架备份机制，提供手动备份功能

### 11.2 产品风险

- **经济失衡：** 建立经济监控体系，及时调整数值参数
- **用户流失：** 通过数据分析优化游戏平衡性，分阶段释放内容
- **复杂度过高：** 采用分阶段开发，确保每个版本的学习成本可控

### 11.3 运营风险

- **数据安全：** 实现完善的备份和恢复机制

---

_本文档版本：v3.2_  
_最后更新：2024年_  
_文档状态：已定稿_  
_主要贡献者：产品分析与需求文档专家_