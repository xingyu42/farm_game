<!DOCTYPE html>
<html lang="zh-CN" data-theme="garden">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的农场</title>
    <link rel="stylesheet" href="../common/lib/daisyui.css">
    <script src="../common/lib/vue.js"></script>
    <script src="../common/lib/unocss.js"></script>
    <script src="../common/lib/iconify.js"></script>
    <style>
        [v-cloak] { display: none; }

        .bg-simple-dark { background-color: #263238; }

        .bg-wood-panel {
            background-color: #6d4c41;
            background-image:
                repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 4px),
                linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.3));
            border: 3px solid #3e2723;
            border-top-color: #8d6e63;
            border-left-color: #795548;
            box-shadow: inset 1px 1px 0 rgba(255,255,255,0.1), 0 4px 8px rgba(0,0,0,0.4);
            border-radius: 1rem;
        }

        .hud-panel::before, .hud-panel::after {
            content: '';
            position: absolute;
            top: 10px;
            width: 8px;
            height: 8px;
            background: #3e2723;
            border-radius: 50%;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5), 0 1px 0 rgba(255,255,255,0.2);
            z-index: 20;
        }
        .hud-panel::before { left: 10px; }
        .hud-panel::after { right: 10px; }

        .farm-bg { background-color: #85be8c; }

        .farm-grid-wrapper {
            position: relative;
            background-color: #c29979;
            border: 24px solid transparent;
            border-image-source: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Cpath fill='%2385be8c' fill-rule='evenodd' d='M0 0h120v120H0z M40 30 Q45 40 50 30 Q55 22 60 30 Q65 38 70 30 Q75 28 80 30 Q90 30 90 40 Q80 45 90 50 Q98 55 90 60 Q78 65 90 70 Q95 75 90 80 Q90 90 80 90 Q75 82 70 90 Q65 98 60 90 Q55 78 50 90 Q45 95 40 90 Q30 90 30 80 Q40 75 30 70 Q22 65 30 60 Q42 55 30 50 Q25 45 30 40 Q30 30 40 30z'/%3E%3Cpath fill='none' stroke='%232B2524' stroke-width='3' d='M40 30 Q45 40 50 30 Q55 22 60 30 Q65 38 70 30 Q75 28 80 30 Q90 30 90 40 Q80 45 90 50 Q98 55 90 60 Q78 65 90 70 Q95 75 90 80 Q90 90 80 90 Q75 82 70 90 Q65 98 60 90 Q55 78 50 90 Q45 95 40 90 Q30 90 30 80 Q40 75 30 70 Q22 65 30 60 Q42 55 30 50 Q25 45 30 40 Q30 30 40 30z'/%3E%3C/svg%3E");
            border-image-slice: 40 fill;
            border-image-repeat: round;
            padding: 16px;
        }

        .plot-base {
            position: relative;
            border-radius: 2px;
            background-color: #a2786a;
        }

        .plot-ready {
            position: relative;
            border-radius: 2px;
            background-color: #a2786a;
            box-shadow: 0 0 0 2px #FFD700;
        }

        .plot-locked {
            position: relative;
            border-radius: 2px;
            background-color: #5d4037;
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-simple-dark min-h-screen flex items-center justify-center font-sans overflow-hidden">

<div id="app" v-cloak class="w-[600px] rounded-3xl overflow-hidden shadow-[0_20px_50px_rgba(0,0,0,0.5)] relative border-4 border-[#3e2723] bg-[#85be8c]">

    <div class="absolute inset-0 pointer-events-none bg-gradient-to-b from-[#81d4fa] to-[#b3e5fc] -z-10"></div>

    <!-- HUD Panel -->
    <div class="hud-panel bg-wood-panel p-4 z-10 relative text-white shadow-lg">
        <div class="flex items-center gap-4 relative z-10">
            <div class="avatar indicator">
                 <span class="indicator-item badge badge-warning font-bold border-2 border-white shadow-md text-stone-800">{{ user.level }}</span>
                <div class="rounded-xl w-16 h-16 ring-2 ring-warning ring-offset-2 ring-offset-[#5d4037] shadow-lg overflow-hidden">
                    <img :src="user.avatar" class="w-full h-full object-cover" />
                </div>
            </div>

            <div class="flex flex-col h-14 justify-around flex-1">
                <div class="font-extrabold text-xl drop-shadow-md tracking-wide text-white flex items-center gap-2">
                    {{ user.name }}
                </div>
                <div class="badge badge-lg gap-2 bg-black/40 border-white/10 text-yellow-300 font-bold px-3 shadow-inner h-8 w-fit backdrop-blur-sm">
                    <span class="iconify text-lg" data-icon="emojione:money-bag"></span>
                    <span class="tracking-widest">{{ user.gold.toLocaleString() }}</span>
                </div>
            </div>

            <!-- Operation Result -->
            <div v-if="opResult" class="flex flex-col items-end gap-0.5 text-right px-3 py-2 rounded-lg min-w-[100px]"
                 :class="opResult.type === 'warning' ? 'bg-amber-900/40 border border-amber-600/50' : 'bg-lime-900/40 border border-lime-600/50'">
                <div class="flex items-center gap-1.5 text-sm font-bold" :class="opResult.type === 'warning' ? 'text-amber-300' : 'text-lime-300'">
                    <span class="iconify" :data-icon="opResult.icon"></span>
                    <span>{{ opResult.title }}</span>
                </div>
                <div v-for="(line, i) in opResult.details" :key="i" class="text-xs text-stone-200/90">{{ line }}</div>
            </div>
        </div>

        <!-- EXP Bar -->
        <div class="w-full h-3 bg-[#3e2723] rounded-full mt-4 overflow-hidden shadow-[inset_0_1px_3px_rgba(0,0,0,0.5)]">
            <div class="h-full bg-[linear-gradient(to_right,#a3e635,#65a30d)]" :style="{ width: user.exp + '%' }"></div>
        </div>
    </div>

    <!-- Farm Grid -->
    <div class="farm-area farm-bg p-5 shadow-[inset_0_10px_20px_rgba(0,0,0,0.1)] min-h-[440px] relative z-0">
        <div class="farm-grid-wrapper">
            <div class="grid grid-cols-6 gap-4 relative z-10">
            <div v-for="plot in plots" :key="plot.id"
                 class="aspect-square rounded-xl relative flex justify-center items-center"
                 :class="getPlotClass(plot)">

                <span class="absolute top-0.5 left-1 text-[10px] font-bold text-stone-700/70 select-none">{{ plot.id }}</span>

                <!-- Locked -->
                <div v-if="plot.isLocked" class="flex items-center justify-center opacity-40">
                    <span class="iconify text-xl text-stone-900" data-icon="fa6-solid:lock"></span>
                </div>

                <!-- Crop -->
                <div v-else-if="plot.crop" class="relative w-full h-full flex justify-center items-center">
                    <div v-if="plot.state === 'growing'" class="absolute w-11 h-11 rounded-full opacity-60"
                         :style="getProgressStyle(plot.progress, plot.alert)"></div>
                    <span class="iconify text-2xl z-10 drop-shadow-sm filter select-none"
                          :class="{'scale-110': plot.state === 'ready'}"
                          :data-icon="plot.cropIcon"></span>
                </div>

                <!-- Quality Star -->
                <span v-if="plot.quality !== 'normal' && !plot.isLocked"
                      class="iconify absolute bottom-0 left-0 -translate-x-1/2 translate-y-1/2 text-sm drop-shadow-[0_1px_1px_rgba(0,0,0,0.5)] z-20"
                      data-icon="fa6-solid:star"
                      :style="{ color: getQualityStarColor(plot.quality) }"></span>

                <!-- Status Badges -->
                <div v-if="plot.state === 'ready'" class="absolute -top-1.5 -right-1.5 badge badge-xs badge-warning w-5 h-5 p-0 border-2 border-white shadow-sm flex items-center justify-center z-20">
                    <span class="iconify text-[10px] text-stone-800" data-icon="fa6-solid:check"></span>
                </div>
                <div v-if="plot.alert === 'water'" class="absolute -bottom-1.5 -right-1.5 badge badge-xs badge-info w-5 h-5 p-0 border-2 border-white shadow-sm flex items-center justify-center z-20">
                    <span class="iconify text-[10px] text-white" data-icon="ion:water"></span>
                </div>
                <div v-if="plot.alert === 'pest'" class="absolute -bottom-1.5 -right-1.5 badge badge-xs badge-error w-5 h-5 p-0 border-2 border-white shadow-sm flex items-center justify-center z-20">
                    <span class="iconify text-[10px] text-white" data-icon="fa6-solid:bug"></span>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Footer Stats -->
    <div class="bg-wood-panel py-3 px-6 flex justify-between text-white font-bold text-sm shadow-[0_-4px_10px_rgba(0,0,0,0.1)] relative border-t-4 border-[#5d4037] z-20">
        <div class="absolute top-1/2 left-3 w-2.5 h-2.5 bg-[#3e2723] rounded-full -translate-y-1/2 shadow-[inset_1px_1px_2px_rgba(255,255,255,0.2)]"></div>
        <div class="absolute top-1/2 right-3 w-2.5 h-2.5 bg-[#3e2723] rounded-full -translate-y-1/2 shadow-[inset_1px_1px_2px_rgba(255,255,255,0.2)]"></div>

        <div class="flex items-center gap-1.5 bg-black/20 px-3 py-1.5 rounded-lg border border-white/5">
            <span class="iconify text-lg text-lime-300 filter drop-shadow" data-icon="lucide:sprout"></span>
            <span class="text-lime-50 text-shadow-sm">种植: {{ stats.planted }}</span>
        </div>
        <div class="flex items-center gap-1.5 bg-black/20 px-3 py-1.5 rounded-lg border border-white/5">
            <span class="iconify text-lg text-amber-300 filter drop-shadow" data-icon="lucide:package"></span>
            <span class="text-amber-50 text-shadow-sm">待收: {{ stats.ready }}</span>
        </div>
         <div class="flex items-center gap-1.5 bg-black/20 px-3 py-1.5 rounded-lg border border-white/5" :class="stats.issues > 0 ? 'text-red-200 bg-red-900/20' : 'text-stone-300'">
            <span class="iconify text-lg filter drop-shadow" data-icon="lucide:alert-triangle"></span>
            <span class="text-shadow-sm">异常: {{ stats.issues }}</span>
        </div>
    </div>
</div>

<script>
    const { createApp, computed, ref, onMounted } = Vue;

    createApp({
        setup() {
            // === 数据注入 ===
            const s = window.FARM_DATA || {};

            const user = ref({
                name: s.playerName || '未知',
                avatar: s.avatarUrl || '',
                level: s.level || 1,
                gold: s.gold || 0,
                exp: s.expPercent || 0
            });

            const lands = Array.isArray(s.lands) ? s.lands : [];
            const maxSlots = s.maxLandCount || 24;
            const initialPlots = [];

            for (let i = 1; i <= maxSlots; i++) {
                const land = lands.find(l => l.id === i);
                if (land) {
                    initialPlots.push({
                        id: land.id,
                        quality: land.quality || 'normal',
                        state: land.isEmpty ? 'empty' : (land.status === 'mature' ? 'ready' : 'growing'),
                        crop: land.isEmpty ? null : (land.cropName || 'crop'),
                        cropIcon: land.cropIcon || '',
                        progress: land.growthPercent ?? 0,
                        alert: land.hasPests ? 'pest' : (land.needsWater ? 'water' : null),
                        isLocked: false
                    });
                } else {
                    initialPlots.push({ id: i, state: 'locked', quality: 'normal', isLocked: true, crop: null, alert: null, progress: 0, cropIcon: '' });
                }
            }

            const plots = ref(initialPlots);

            const opResult = s.operationResult ? ref(s.operationResult) : ref(null);

            const stats = computed(() => ({
                planted: plots.value.filter(p => p.state === 'growing' || p.state === 'ready').length,
                ready: plots.value.filter(p => p.state === 'ready').length,
                issues: plots.value.filter(p => p.alert).length
            }));

            const getPlotClass = (plot) => {
                if (plot.isLocked) return 'plot-locked';
                if (plot.state === 'ready') return 'plot-ready';
                return plot.state === 'growing' ? 'plot-base wet' : 'plot-base dry';
            };

            const getProgressStyle = (percent, alert) => {
                let color = '#76ff03';
                if (alert === 'water') color = '#fb923c';
                if (alert === 'pest') color = '#ef4444';
                return {
                    background: `conic-gradient(${color} ${percent}%, transparent 0)`,
                    '-webkit-mask': 'radial-gradient(transparent 58%, black 60%)',
                    'mask': 'radial-gradient(transparent 58%, black 60%)'
                };
            };

            const getQualityStarColor = (quality) => {
                const map = { red: '#C75B39', black: '#2D2D2D', gold: '#FFB300' };
                return map[quality] || '#888';
            };

            onMounted(() => {
                document.body.classList.add('ready');
            });

            return { user, plots, stats, opResult, getPlotClass, getProgressStyle, getQualityStarColor };
        }
    }).mount('#app');
</script>

</body>
</html>
